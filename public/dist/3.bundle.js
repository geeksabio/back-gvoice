(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{116:function(e,t,i){},117:function(e,t,i){},134:function(e,t,i){"use strict";i.r(t);var n=i(2),r=i(0),o=i(11),s=i(90),a=i(17),c=i(26),l=i(24),d=i(16),h=i(15),u=i(3),p=i(4),m=i(37),g=i(5),v=i(6),f=i(9),b=i(106),E=i(92);var S=function(e,t,i,n){return new(i||(i=Promise))(function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(s,a)}c((n=n.apply(e,t||[])).next())})};const y=50;class w{constructor(){if(!Object(f.f)())throw new Error("cannot use ios audio in web app");this.lastUpdate=Date.now(),window.levels=(e=>{if(!this.volumeCallback)return;let t=Date.now();if(t-this.lastUpdate>y){this.lastUpdate=t;let i=1.5*(parseInt(e,10)+70);this.volumeCallback(i)}}),window.nativemsgs=this.handleNativeMessage.bind(this);let e=webkit.messageHandlers.scriptHandler;this.postMessage=e.postMessage.bind(e),this.postMessage("lockportrait")}clear(){this.last=null}isMicrophoneSupported(){return!0}isAudioRecordingSupported(){return!0}handleNativeMessage(e){if("nomicpermission"===e)(function(e,t,i){const n=document.createElement("div");n.classList.add("confirm-modal");const r=document.createElement("div");r.classList.add("main-section"),n.appendChild(r);const o=document.createElement("label");o.textContent=e,r.appendChild(o);const s=document.createElement("button");s.id="confirm-confirm",s.textContent=t,r.appendChild(s);const a=document.createElement("button");function c(){n.parentElement.removeChild(n)}return a.id="confirm-cancel",a.textContent=i,r.appendChild(a),new Promise((e,t)=>{document.body.appendChild(n),s.addEventListener("click",()=>{c(),e(!0)}),a.addEventListener("click",()=>{c(),e(!1)}),setTimeout(()=>{n.classList.add("visible")})})})("Please allow microphone access to record your voice.","Go to Settings","Cancel").then(e=>{e&&vcopensettings()});else if("capturestarted"===e){if(this.pendingStart){let e=this.pendingStart;this.pendingStart=null,this.pendingStartError=null,e()}}else if("errorrecording"===e){if(this.pendingStart){let e=this.pendingStartError;this.pendingStart=null,this.pendingStartError=null,e("Unable to start recording")}}else console.log("unhandled native message",e)}init(){return S(this,void 0,void 0,function*(){return!0})}setVolumeCallback(e){this.volumeCallback=e}start(){return new Promise((e,t)=>{this.pendingStart=e,this.pendingStartError=t,this.postMessage("startCapture")})}stop(){return new Promise((e,t)=>{window.uploadData=(t=>{this.last={url:"data:"+w.AUDIO_TYPE_URL+","+t,blob:new Blob([t],{type:w.AUDIO_TYPE})},e(this.last)}),this.postMessage("stopCapture")})}release(){}play(){this.postMessage("playCapture")}}w.AUDIO_TYPE="audio/m4a;base64",w.AUDIO_TYPE_URL="audio/mp4;base64";var O=function(e,t,i,n){return new(i||(i=Promise))(function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(s,a)}c((n=n.apply(e,t||[])).next())})};const R="audio/ogg; codecs=opus";var T;!function(e){e.NOT_ALLOWED="NOT_ALLOWED",e.NO_MIC="NO_MIC",e.NO_SUPPORT="NO_SUPPORT"}(T||(T={}));class k{constructor(){if(Object(f.f)())throw new Error("cannot use web audio in iOS app");this.visualize=this.visualize.bind(this)}isReady(){return!!this.microphone}getMicrophone(){return new Promise(function(e,t){function i(e){t({NotAllowedError:T.NOT_ALLOWED,NotFoundError:T.NO_MIC}[e.name]||e)}function n(t){e(t)}navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then(n,i):navigator.getUserMedia?navigator.getUserMedia({audio:!0},n,i):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia({audio:!0},n,i):navigator.mozGetUserMedia?navigator.mozGetUserMedia({audio:!0},n,i):t(T.NO_SUPPORT)})}isMicrophoneSupported(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia}isAudioRecordingSupported(){return"undefined"!=typeof MediaRecorder}visualize(){this.analyzerNode.getByteFrequencyData(this.frequencyBins);let e=0;for(var t=0;t<this.frequencyBins.length;t++)e+=this.frequencyBins[t];let i=e/this.frequencyBins.length;this.volumeCallback&&this.volumeCallback(i)}startVisualize(){this.jsNode.onaudioprocess=this.visualize}stopVisualize(){this.jsNode.onaudioprocess=void 0,this.volumeCallback&&this.volumeCallback(100)}setVolumeCallback(e){this.volumeCallback=e}init(){return O(this,void 0,void 0,function*(){if(this.isReady())return;const e=yield this.getMicrophone();this.microphone=e;var t=new AudioContext,i=t.createMediaStreamSource(e),n=t.createGain(),r=t.createAnalyser(),o=t.createMediaStreamDestination();i.channelCount=1,n.channelCount=1,r.channelCount=1,o.channelCount=1,i.connect(n),n.connect(r),r.connect(o),this.recorder=new MediaRecorder(o.stream),r.fftSize=128,r.smoothingTimeConstant=.96,this.frequencyBins=new Uint8Array(r.frequencyBinCount),this.jsNode=t.createScriptProcessor(256,1,1),this.jsNode.connect(t.destination),t.createGain().connect(t.destination),this.analyzerNode=r,this.audioContext=t})}start(){return this.isReady()?new Promise((e,t)=>{this.chunks=[],this.recorder.ondataavailable=(e=>{this.chunks.push(e.data)}),this.recorder.onstart=(t=>{this.clear(),e()}),this.startVisualize(),this.recorder.start(2e4)}):(console.error("Cannot record audio before microhphone is ready."),Promise.resolve())}stop(){return this.isReady()?new Promise((e,t)=>{this.stopVisualize(),this.recorder.onstop=(t=>{let i=new Blob(this.chunks,{type:R});this.last={url:URL.createObjectURL(i),blob:i},e(this.last)}),this.recorder.stop()}):(console.error("Cannot stop audio before microhphone is ready."),Promise.resolve({}))}release(){if(this.microphone)for(const e of this.microphone.getTracks())e.stop();this.microphone=null}clear(){this.lastRecordingUrl&&URL.revokeObjectURL(this.lastRecordingUrl),this.lastRecordingData=null,this.lastRecordingUrl=null}}var C=i(103),M=(i(116),function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&(i[n[r]]=e[n[r]])}return i});const{Tooltip:U}=i(96);var L=Object(p.e)(Object(n.withLocalization)(class extends r.Component{constructor(){super(...arguments),this.audioRef=r.createRef(),this.state={isPlaying:!1,showSentenceTooltip:!1},this.toggleIsPlaying=(()=>{const{locale:e}=this.props,{current:t}=this.audioRef,i=!this.state.isPlaying;i?(Object(h.f)("listen",e),t.play()):(t.pause(),t.currentTime=0),this.setState({isPlaying:i})}),this.showSentenceTooltip=(()=>this.setState({showSentenceTooltip:!0})),this.hideSentenceTooltip=(()=>this.setState({showSentenceTooltip:!1}))}render(){const e=this.props,{children:t,clip:i,getString:o,onRerecord:s,onShare:a,status:c}=e,l=M(e,["children","clip","getString","onRerecord","onShare","status"]),{isPlaying:d,showSentenceTooltip:h}=this.state;return r.createElement(C.a,Object.assign({},l,{className:"recording",openable:!0,status:c}),t,!t&&"active"===c&&r.createElement(n.Localized,{id:"record-cta"},r.createElement("div",{className:"text"})),!t&&"done"===c&&r.createElement(r.Fragment,null,r.createElement("audio",{src:i.recording.url,preload:"auto",onEnded:this.toggleIsPlaying,ref:this.audioRef}),r.createElement(U,{arrow:!0,open:d||h,theme:"grey-tooltip",title:i.sentence.text},r.createElement("button",{className:"play",type:"button",onClick:this.toggleIsPlaying,onMouseEnter:this.showSentenceTooltip,onMouseLeave:this.hideSentenceTooltip},r.createElement("span",{className:"padder"},d?r.createElement(g.D,null):r.createElement(g.x,null)))),d?r.createElement("div",{className:"placeholder"}):r.createElement(r.Fragment,null,r.createElement(U,{arrow:!0,title:o("review-tooltip")},r.createElement("button",{className:"redo",type:"button",onClick:s},r.createElement("span",{className:"padder"},r.createElement(g.y,null)))),r.createElement("button",{className:"share",type:"button",onClick:a},r.createElement("span",{className:"padder"},r.createElement(g.B,null))))))}})),P=(i(117),function(e,t,i,n){return new(i||(i=Promise))(function(r,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(s,a)}c((n=n.apply(e,t||[])).next())})});const x=i(115).default,N=300,I=1e4,_=1;var z;!function(e){e.TOO_SHORT="TOO_SHORT",e.TOO_LONG="TOO_LONG",e.TOO_QUIET="TOO_QUIET"}(z||(z={}));const D=()=>r.createElement("div",{className:"unsupported"},r.createElement(n.Localized,{id:"record-platform-not-supported"},r.createElement("h2",null)),r.createElement("p",{key:"desktop"},r.createElement(n.Localized,{id:"record-platform-not-supported-desktop"},r.createElement("span",null)),r.createElement("a",{target:"_blank",href:"https://www.firefox.com/"},r.createElement(g.n,{type:"firefox"}),"Firefox")," ",r.createElement("a",{target:"_blank",href:"https://www.google.com/chrome"},r.createElement(g.n,{type:"chrome"}),"Chrome")),r.createElement("p",{key:"ios"},r.createElement(n.Localized,{id:"record-platform-not-supported-ios",bold:r.createElement("b",null)},r.createElement("span",null))),r.createElement("a",{target:"_blank",href:Object(f.b)()},r.createElement("img",{src:"/img/appstore.svg"}))),j={clips:[],isSubmitted:!1,error:null,recordingStatus:null,rerecordIndex:null,showPrivacyModal:!1,showDiscardModal:!1};const A={addNotification:a.a.actions.add,addUploads:l.a.actions.add,removeSentences:c.a.actions.remove,tallyRecording:d.a.actions.tallyRecording,refreshUser:d.a.actions.refresh,updateUser:d.a.actions.update};t.default=Object(s.a)(Object(p.e)(Object(n.withLocalization)(Object(o.b)(e=>({api:e.api,locale:e.locale,sentences:c.a.selectors.localeSentences(e),user:e.user}),A)(class extends r.Component{constructor(){super(...arguments),this.state=j,this.isUnsupportedPlatform=!1,this.maxVolume=0,this.recordingStartTime=0,this.recordingStopTime=0,this.releaseMicrophone=(()=>{document.hidden&&(this.isRecording&&this.saveRecording(),this.audio.release())}),this.processRecording=(e=>{const t=this.getRecordingError();if(t)return this.setState({error:t});const{clips:i}=this.state;this.setState({clips:i.map(({recording:t,sentence:i},n)=>({recording:n===this.getRecordingIndex()?e:t,sentence:i})),rerecordIndex:null}),Object(h.f)("record",this.props.locale)}),this.getRecordingError=(()=>{const e=this.recordingStopTime-this.recordingStartTime;return e<N?z.TOO_SHORT:e>I?z.TOO_LONG:this.maxVolume<_?z.TOO_QUIET:null}),this.updateVolume=(e=>{100!==e&&e>this.maxVolume&&(this.maxVolume=e)}),this.rerecord=(e=>P(this,void 0,void 0,function*(){Object(h.f)("rerecord",this.props.locale),yield this.discardRecording(),this.setState({rerecordIndex:e})})),this.handleRecordClick=(()=>P(this,void 0,void 0,function*(){if("waiting"===this.state.recordingStatus)return;const e=this.isRecording;if(this.setState({recordingStatus:"waiting"}),e)this.saveRecording();else try{yield this.audio.init(),yield this.startRecording()}catch(e){if(!(e in T))throw e;this.setState({error:e})}})),this.startRecording=(()=>P(this,void 0,void 0,function*(){yield this.audio.start(),this.maxVolume=0,this.recordingStartTime=Date.now(),this.recordingStopTime=0,this.setState({recordingStatus:"recording",error:null})})),this.saveRecording=(()=>{this.audio.stop().then(this.processRecording),this.recordingStopTime=Date.now(),this.setState({recordingStatus:null})}),this.discardRecording=(()=>P(this,void 0,void 0,function*(){this.isRecording&&(yield this.audio.stop(),this.setState({recordingStatus:null}))})),this.cancelReRecord=(()=>P(this,void 0,void 0,function*(){yield this.discardRecording(),this.setState({rerecordIndex:null})})),this.handleSkip=(()=>P(this,void 0,void 0,function*(){const{api:e,removeSentences:t,sentences:i}=this.props,{clips:n}=this.state;yield this.discardRecording();const{id:r}=n[this.getRecordingIndex()].sentence;t([r]),this.setState({clips:n.map((e,t)=>this.getRecordingIndex()===t?{recording:null,sentence:i.slice(b.a)[0]}:e),error:null}),yield e.skipSentence(r)})),this.upload=((e=!1)=>{const{addNotification:t,addUploads:i,api:o,locale:s,removeSentences:a,tallyRecording:c,user:l,refreshUser:d}=this.props;if(!e&&!l.privacyAgreed&&!l.account)return this.setState({showPrivacyModal:!0}),!1;const u=this.state.clips.filter(e=>e.recording);return a(u.map(e=>e.sentence.id)),this.setState({clips:[],isSubmitted:!0}),i([...u.map(({sentence:e,recording:t})=>()=>P(this,void 0,void 0,function*(){let i=3;for(;i;)try{yield o.uploadClip(t.blob,e.id,e.text),l.account||c(),i=0}catch(e){console.error(e),i--,yield new Promise(e=>setTimeout(e,1e3)),0==i&&confirm("Upload of this clip keeps failing, keep retrying?")&&(i=3)}})),()=>P(this,void 0,void 0,function*(){Object(h.f)("submit",s),d(),t(r.createElement(r.Fragment,null,r.createElement(g.d,null)," ",r.createElement(n.Localized,{id:"clips-uploaded"},r.createElement("span",null))))})]),!0}),this.resetState=(e=>this.setState(j,e)),this.agreeToTerms=(()=>P(this,void 0,void 0,function*(){this.setState({showPrivacyModal:!1}),this.props.updateUser({privacyAgreed:!0}),this.upload(!0)})),this.toggleDiscardModal=(()=>{this.setState({showPrivacyModal:!1,showDiscardModal:!this.state.showDiscardModal})}),this.resetAndGoHome=(()=>{const{history:e,toLocaleRoute:t}=this.props;this.resetState(()=>{e.push(t(u.a.ROOT)),window.scrollTo({top:0,behavior:"smooth"})})})}static getDerivedStateFromProps(e,t){return t.clips.length>0?null:e.sentences.length>0?{clips:e.sentences.slice(0,b.a).map(e=>({recording:null,sentence:e}))}:null}componentDidMount(){this.audio=Object(f.f)()?new w:new k,this.audio.setVolumeCallback(this.updateVolume.bind(this)),document.addEventListener("visibilitychange",this.releaseMicrophone),this.audio.isMicrophoneSupported()&&this.audio.isAudioRecordingSupported()&&!Object(f.c)()||(this.isUnsupportedPlatform=!0)}componentWillUnmount(){return P(this,void 0,void 0,function*(){document.removeEventListener("visibilitychange",this.releaseMicrophone),this.isRecording&&(yield this.audio.stop())})}get isRecording(){return"recording"===this.state.recordingStatus}getRecordingIndex(){const{rerecordIndex:e}=this.state;return null===e?this.state.clips.findIndex(({recording:e})=>!e):e}render(){const{getString:e,user:t}=this.props,{clips:i,isSubmitted:o,error:s,recordingStatus:a,rerecordIndex:c,showPrivacyModal:l,showDiscardModal:d}=this.state,h=this.getRecordingIndex();return r.createElement(r.Fragment,null,r.createElement(x,{when:i.filter(e=>e.recording).length>0},({onConfirm:e,onCancel:t})=>r.createElement(m.b,{innerClassName:"record-abort",onRequestClose:t},r.createElement(n.Localized,{id:"record-abort-title"},r.createElement("h1",{className:"title"})),r.createElement(n.Localized,{id:"record-abort-text"},r.createElement("p",{className:"text"})),r.createElement(m.a,null,r.createElement(n.Localized,{id:"record-abort-submit"},r.createElement(v.b,{outline:!0,rounded:!0,onClick:()=>{this.upload()&&e()}})),r.createElement(n.Localized,{id:"record-abort-continue"},r.createElement(v.b,{outline:!0,rounded:!0,onClick:t}))),r.createElement(n.Localized,{id:"record-abort-delete"},r.createElement(v.k,{onClick:e})))),l&&r.createElement(n.Localized,{id:"review-terms",termsLink:r.createElement(p.b,{to:u.a.TERMS,blank:!0}),privacyLink:r.createElement(p.b,{to:u.a.PRIVACY,blank:!0})},r.createElement(m.b,{buttons:{[e("terms-agree")]:this.agreeToTerms,[e("terms-disagree")]:this.toggleDiscardModal}})),d&&r.createElement(n.Localized,{id:"review-aborted"},r.createElement(m.b,{buttons:{[e("review-keep-recordings")]:this.toggleDiscardModal,[e("review-delete-recordings")]:this.resetAndGoHome}})),r.createElement(b.b,{activeIndex:h,errorContent:this.isUnsupportedPlatform&&r.createElement(D,null),extraButton:r.createElement(n.Localized,{id:"unable-speak"},r.createElement(p.b,{to:u.a.LISTEN})),instruction:e=>s?r.createElement("div",{className:"error"},r.createElement(n.Localized,Object.assign({id:{[z.TOO_SHORT]:"record-error-too-short",[z.TOO_LONG]:"record-error-too-long",[z.TOO_QUIET]:"record-error-too-quiet",[T.NOT_ALLOWED]:"record-must-allow-microphone",[T.NO_MIC]:"record-no-mic-found",[T.NO_SUPPORT]:"record-platform-not-supported"}[s]},e))):r.createElement(n.Localized,Object.assign({id:this.isRecording?"record-stop-instruction":h===b.a-1?"record-last-instruction":["record-instruction","record-again-instruction"][h]||"record-again-instruction2",recordIcon:r.createElement(g.u,null),stopIcon:r.createElement(g.D,null)},e)),isFirstSubmit:0===t.recordTally,isPlaying:this.isRecording,isSubmitted:o,onReset:()=>this.resetState(),onSkip:this.handleSkip,onSubmit:()=>this.upload(),primaryButtons:r.createElement(E.d,{status:a,onClick:this.handleRecordClick}),pills:i.map((e,t)=>i=>r.createElement(L,Object.assign({},i,{clip:e,status:h===t?"active":e.recording?"done":"pending",onRerecord:()=>this.rerecord(t)}),c===t&&r.createElement(n.Localized,{id:"record-cancel"},r.createElement(v.k,{onClick:this.cancelReRecord})))),sentences:i.map(({sentence:{text:e}})=>e),shortcuts:[{key:"shortcut-record-toggle",label:"shortcut-record-toggle-label",action:this.handleRecordClick}],type:"speak"}))}}))))}}]);